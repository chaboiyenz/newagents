{% extends 'index.html' %}

{% block title %} Project Listings {% endblock %}

{% block content %}
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    window.isUserSuperuser = {% if user.is_superuser %}true{% else %}false{% endif %};
  });
</script>


  <div class="flex flex-col lg:flex-row gap-8">
    <!-- Filter Section - Left Side -->
    <div class="lg:w-1/4 flex-shrink-0">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 transition duration-300 hover:shadow-xl backdrop-blur-lg bg-opacity-95 sticky top-8">
        <div class="mb-6">
          <h3 class="text-3xl font-bold text-blue-600 mb-2 leading-tight">Find Project</h3>
          <p class="text-lg text-gray-600 leading-relaxed">Use the filters below to discover property match.</p>
        </div>
        
        <!-- Search Bar -->
        <div class="mb-6">
          <label for="property-search" class="block text-xl font-semibold text-gray-700 mb-2">Search Property</label>
          <div class="relative flex items-center">
            <div class="absolute left-4 pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input 
              type="text" 
              id="property-search" 
              style="padding-left: 2.75rem !important;"
              class="w-full px-4 py-3 text-lg bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm" 
              placeholder="" 
              oninput="searchProperties()"
            >
          </div>
        </div>
          
        <div class="space-y-5">
          <!-- Province Dropdown -->
          <div>
            <label for="province-dropdown" class="block text-xl font-semibold text-gray-700 mb-2">Province</label>
            <div class="relative">
              <select id="province-dropdown" class="w-full px-4 py-3 text-lg bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none transition shadow-sm" onchange="updateCities()">
                <option value="">Select a Province</option>
                {% for province in provinces %}
                  <option value="{{ province.id }}">{{ province.name }}</option>
                {% empty %}
                  <option disabled>No provinces available</option>
                {% endfor %}
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- City Dropdown -->
          <div>
            <label for="city-dropdown" class="block text-xl font-semibold text-gray-700 mb-2">City</label>
            <div class="relative">
              <select id="city-dropdown" class="w-full px-4 py-3 text-lg bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none transition shadow-sm" onchange="updateSubdivisionsByPrice()">
                <option value="">Select a City</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Price Range Dropdown -->
          <div>
            <label for="price-range-dropdown" class="block text-xl font-semibold text-gray-700 mb-2">Price Range</label>
            <div class="relative">
              <select id="price-range-dropdown" class="w-full px-4 py-3 text-lg bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none transition shadow-sm" onchange="updateSubdivisionsByPrice()">
                <option value="all">All Price Ranges</option>
                <option value="0-500000">₱0 - ₱500,000</option>
                <option value="500000-1000000">₱500,000 - ₱1,000,000</option>
                <option value="1000000-2000000">₱1,000,000 - ₱2,000,000</option>
                <option value="2000000-5000000">₱2,000,000 - ₱5,000,000</option>
                <option value="5000000-10000000">₱5,000,000 - ₱10,000,000</option>
                <option value="10000000-">₱10,000,000+</option>
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content - Right Side -->
    <div class="lg:w-3/4">
      <!-- Properties Count Display -->
      <div class="properties-count-display mb-6">
        <div class="inline-flex items-center justify-between bg-white px-6 py-4 rounded-xl shadow-sm border border-gray-100">
          <p class="text-2xl text-gray-700">
            <span class="font-semibold">0</span> properties found
          </p>
          <div class="flex gap-3 ml-6">
            <button onclick="toggleViewMode('grid')" class="p-2 rounded-lg hover:bg-gray-100 transition" title="Grid View">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
            </button>
            <button onclick="toggleViewMode('list')" class="p-2 rounded-lg hover:bg-gray-100 transition" title="List View">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Subdivision Preview -->
      <div id="subdivision-preview" class="hidden mb-8 rounded-3xl shadow-2xl overflow-hidden border border-gray-100 transition-all duration-300 ease-in-out w-full bg-white">
        <div class="flex flex-col lg:flex-row">
          <!-- Left Side - Images -->
          <div class="lg:w-1/2 p-6 bg-gray-50">
            <!-- Main Image Container with strictly fixed size -->
            <div style="height: 500px; min-height: 500px; max-height: 500px;" class="w-full overflow-hidden rounded-2xl mb-4 shadow-lg group relative">
              <img 
                id="main-subdivision-image" 
                src="" 
                alt="Subdivision" 
                style="height: 500px; min-height: 500px; max-height: 500px; width: 100%; object-fit: cover; object-position: center;"
                class="rounded-2xl transition duration-500 group-hover:scale-105"
              >
              <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>

            <!-- Thumbnails with fixed size -->
            <div id="subdivision-thumbnails" class="grid grid-cols-4 gap-4 p-2 bg-white rounded-xl shadow-sm">
              <!-- Thumbnails will be populated by JS -->
            </div>
          </div>

          <!-- Right Side - Details -->
          <div class="lg:w-1/2 p-8 bg-white">
            <div class="mb-8">
              <h3 id="subdivision-name" class="text-4xl font-bold text-gray-800 mb-4"></h3>
              <div class="flex flex-wrap gap-3 mb-6">
                <span id="subdivision-commission" class="inline-flex items-center px-4 py-2 bg-yellow-100 text-yellow-800 text-xl font-bold rounded-lg">
                  <!-- Commission will be inserted here by JS -->
                </span>
                <span id="subdivision-priority" class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-xl font-semibold rounded-lg"></span>
              </div>
            </div>

            <!-- Price Display -->
            <div class="mb-8">
              <span id="subdivision-price" class="text-4xl font-bold text-blue-600 bg-blue-50 px-6 py-3 rounded-xl inline-block"></span>
            </div>

            <!-- Property Information -->
            <div class="bg-gray-50 rounded-2xl p-6 mb-8">
              <h4 class="text-2xl font-semibold text-gray-800 mb-4">Property Details</h4>
              <div class="space-y-4">
                <div class="flex items-start">
                  <div class="w-40 flex-shrink-0">
                    <span class="text-gray-600 font-medium">House Model</span>
                  </div>
                  <div class="flex-grow">
                    <span id="subdivision-house-model" class="text-gray-800"></span>
                  </div>
                </div>
                <div class="flex items-start">
                  <div class="w-40 flex-shrink-0">
                    <span class="text-gray-600 font-medium">House Type</span>
                  </div>
                  <div class="flex-grow">
                    <span id="subdivision-description" class="text-gray-800"></span>
                  </div>
                </div>
                <div class="flex items-start">
                  <div class="w-40 flex-shrink-0">
                    <span class="text-gray-600 font-medium">Status</span>
                  </div>
                  <div class="flex-grow">
                    <span id="subdivision-construction-status" class="text-gray-800"></span>
                  </div>
                </div>
                <div class="flex items-start">
                  <div class="w-40 flex-shrink-0">
                    <span class="text-gray-600 font-medium">Developer</span>
                  </div>
                  <div class="flex-grow">
                    <span id="subdivision-developer" class="text-gray-800"></span>
                  </div>
                </div>
                <div class="flex items-start">
                  <div class="w-40 flex-shrink-0">
                    <span class="text-gray-600 font-medium">Location</span>
                  </div>
                  <div class="flex-grow">
                    <span id="subdivision-location" class="text-gray-800"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Links -->
            <div class="space-y-4">
              <!-- Google Drive Link -->
              <div id="google-drive-row" class="hidden">
                <a id="google-drive-link" href="#" target="_blank" 
                   class="w-full flex items-center justify-center px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition shadow-sm group">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 group-hover:scale-110 transition-transform" viewBox="0 0 87.3 78">
                    <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
                    <path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/>
                    <path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l6.85 11.85z" fill="#ea4335"/>
                    <path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/>
                    <path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/>
                    <path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
                  </svg>
                  View on Google Drive
                </a>
              </div>

              <!-- Messenger Link -->
              <div id="messenger-link-container" class="hidden">
                <button 
                  class="open-messenger-modal w-full flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-md group"
                  type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  Contact via Messenger
                  <span class="ml-2 group-hover:translate-x-1 transition-transform">→</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="hidden mb-8 rounded-3xl shadow-2xl overflow-hidden border border-gray-100 transition-all duration-300 ease-in-out w-full bg-white p-12">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          <span class="ml-3 text-lg text-gray-600">Loading property details...</span>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden mb-8 rounded-3xl shadow-2xl overflow-hidden border border-red-100 transition-all duration-300 ease-in-out w-full bg-red-50 p-12">
        <div class="text-center">
          <svg class="mx-auto h-16 w-16 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-xl font-medium text-red-800 mb-2">Error Loading Property</h3>
          <p class="text-red-600" id="error-message">Unable to load property details. Please try again.</p>
        </div>
      </div>

      <!-- Subdivisions Container -->
      <div id="subdivisions-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <!-- Cards will be populated by JS -->
      </div>

      {% if not provinces_selected and not city_selected and not price_range_selected %}
        <div id="highest-priority-section" class="mt-20">
          <div class="flex items-center mb-10">
            <div class="flex-grow h-px bg-gray-200"></div>
            <h3 class="mx-4 text-4xl font-bold text-blue-600 px-8 py-3 bg-gray-50 rounded-full shadow-sm">Top Priority Properties</h3>
            <div class="flex-grow h-px bg-gray-200"></div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for subdivision in top_priority_subdivisions %}
              <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 transition duration-300 hover:shadow-xl hover:translate-y-[-5px] cursor-pointer group"
                   onclick="showSubdivisionPreview({
                     'id': {{ subdivision.id|escapejs }},
                     'name': '{{ subdivision.name|escapejs }}',
                     'description': '{{ subdivision.description|default:'No description available'|escapejs }}',
                     'price_range_display': '{{ subdivision.price_range_display|escapejs }}',
                     'priority': '{{ subdivision.priority|escapejs }}',
                     'image1': '{% if subdivision.image1 %}{{ subdivision.image1.url|escapejs }}{% endif %}',
                     'image2': '{% if subdivision.image2 %}{{ subdivision.image2.url|escapejs }}{% endif %}',
                     'image3': '{% if subdivision.image3 %}{{ subdivision.image3.url|escapejs }}{% endif %}',
                     'image4': '{% if subdivision.image4 %}{{ subdivision.image4.url|escapejs }}{% endif %}',
                     'messenger_link': '{{ subdivision.messenger_link|default:''|escapejs }}',
                     'google_drive_link': '{{ subdivision.google_drive_link|default:''|escapejs }}',
                     'construction_status': '{{ subdivision.construction_status|default:''|escapejs }}',
                     'developer': '{{ subdivision.developer|default:''|escapejs }}',
                     'commission': {{ subdivision.commission|escapejs }},
                     'city': '{{ subdivision.city.name|escapejs }}',
                     'province': '{{ subdivision.city.province.name|escapejs }}',
                     'location': '{{ subdivision.location|default:''|escapejs }}',
                     'house_model': '{{ subdivision.house_model|default:''|escapejs }}'
                   })">
                {% if subdivision.image1 %}
                  <div class="w-full h-56 overflow-hidden rounded-xl mb-6 shadow-md">
                    <img src="{{ subdivision.image1.url }}" alt="{{ subdivision.name }}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                  </div>
                {% endif %}
                <h4 class="text-2xl font-bold text-gray-800 mb-2">
                  {{ subdivision.name }}
                </h4>
                
                <div class="flex flex-wrap gap-2 mb-3">
                  <span class="inline-block bg-gradient-to-r from-yellow-300 to-yellow-400 text-yellow-900 text-lg font-bold px-3 py-1 rounded-full shadow-sm">
                    {{ subdivision.commission }}% COMM
                  </span>
                  <span class="inline-block bg-red-100 text-red-700 text-lg font-semibold px-3 py-1 rounded-full shadow-sm">
                    High Priority
                  </span>
                </div>
                
                <!-- City and Province -->
                <p class="text-gray-500 text-lg mb-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {{ subdivision.city.name }}, {{ subdivision.city.province.name }}
                </p>

                <p class="text-gray-600 text-xl font-semibold mb-4">{{ subdivision.price_range_display|default:'' }}</p>
                
                <p class="text-gray-700 text-lg line-clamp-2 mb-6">
                  {{ subdivision.description|default:'No description available' }}
                </p>
                
                {% if subdivision.messenger_link %}
                  <button
                    class="open-messenger-modal w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl inline-block text-xl font-medium hover:from-blue-700 hover:to-blue-800 transition shadow-md"
                    data-link="{{ subdivision.messenger_link }}"
                    onclick="event.stopPropagation()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    Contact via Messenger
                  </button>
                {% endif %}
              </div>
            {% empty %}
              <div class="col-span-3 bg-gray-50 p-10 rounded-2xl text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
                <p class="text-xl text-gray-600">No high-priority properties available at the moment.</p>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Messenger Link Modal -->
<div id="messenger-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 px-4 sm:px-6 overflow-y-auto hidden backdrop-blur-sm">
  <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-3xl relative mt-6 mb-6 overflow-y-auto max-h-[80vh] border border-gray-100">
    
    <!-- Close Button -->
    <button id="close-messenger-modal" class="absolute top-3 right-3 p-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Title -->
    <div class="flex items-center gap-4 mb-6">
      <div class="bg-blue-100 p-3 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <h3 class="text-2xl font-semibold text-gray-800">Contact via Messenger</h3>
    </div>

    <!-- Link Copy Box -->
    <div class="bg-gray-50 p-4 rounded-lg mb-6">
      <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
        <input id="messenger-url-input" type="text" class="flex-1 px-4 py-3 text-lg border border-gray-300 rounded-lg" readonly>
        <button id="copy-link-btn" class="px-6 py-3 bg-blue-600 text-white text-lg rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          Copy
        </button>
      </div>
      <p id="copy-success" class="text-green-600 text-sm mt-3 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Link copied successfully!
      </p>
    </div>

    <!-- Tutorial Steps -->
    <div class="text-lg text-gray-700 space-y-6">
      <h4 class="font-semibold text-center text-2xl mb-6">Paano gamitin:</h4>

      <div class="space-y-4">
        <div class="flex gap-4 items-center">
          <img src="/media/messenger/step2.jpg" alt="Step 1" class="w-28 h-28 object-cover rounded-lg border">
          <p class="text-lg"><strong class="text-blue-600">Step 1:</strong> Buksan ang Messenger app o Messenger.com</p>
        </div>
        <div class="flex gap-4 items-center">
          <img src="/media/messenger/step3.jpg" alt="Step 2"class="w-28 h-28 object-cover rounded-lg border">
          <p class="text-lg"><strong class="text-blue-600">Step 2:</strong> I-paste ang link sa kahit anong chat.</p>
        </div>
        <div class="flex gap-4 items-center">
          <img src="/media/messenger/step4.jpg" alt="Step 3" class="w-28 h-28 object-cover rounded-lg border">
          <p class="text-lg"><strong class="text-blue-600">Step 3:</strong> I-tap ang "View Chat" para makita ang contact.</p>
        </div>
        <div class="flex gap-4 items-center">
          <img src="/media/messenger/step5.jpg" alt="Step 4" class="w-28 h-28 object-cover rounded-lg border">
          <p class="text-lg"><strong class="text-blue-600">Step 4:</strong> Pwede ka nang mag-message!</p>
        </div>
      </div>

      <p class="text-sm text-gray-500 mt-3 bg-gray-50 p-3 rounded-lg border text-center">
        <em>Tip: Mas gumagana ang links sa Messenger app kaysa browser.</em>
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("messenger-modal");
    const input = document.getElementById("messenger-url-input");
    const closeBtn = document.getElementById("close-messenger-modal");

    // Open modal with dynamic link
    document.querySelectorAll(".open-messenger-modal").forEach(button => {
      button.addEventListener("click", () => {
        const link = button.getAttribute("data-link");
        input.value = link;
        modal.classList.remove("hidden");
      });
    });

    // Close modal
    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // Copy link to clipboard
    document.getElementById("copy-link-btn").addEventListener("click", () => {
      input.select();
      input.setSelectionRange(0, 99999);
      document.execCommand("copy");

      const success = document.getElementById("copy-success");
      success.classList.remove("hidden");
      setTimeout(() => success.classList.add("hidden"), 2000);
    });
  });
</script>

<script>
  document.getElementById("copy-link-btn").addEventListener("click", function () {
    const input = document.getElementById("messenger-url-input");
    input.select();
    input.setSelectionRange(0, 99999); // For mobile
    document.execCommand("copy");

    const successMsg = document.getElementById("copy-success");
    successMsg.classList.remove("hidden");
    setTimeout(() => successMsg.classList.add("hidden"), 2000);
  });
</script>
<script>
  function searchProperties() {
    const query = document.getElementById('property-search').value.toLowerCase();
    const subdivisionsContainer = document.getElementById('subdivisions-container');
    const preview = document.getElementById('subdivision-preview');
    const countDisplay = document.querySelector('.properties-count-display span');

    subdivisionsContainer.innerHTML = '';
    preview.classList.add('hidden');

    if (query) {
      // Show loading state
      subdivisionsContainer.innerHTML = `
        <div class="col-span-full flex items-center justify-center p-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          <span class="ml-3 text-lg text-gray-600">Searching properties...</span>
        </div>
      `;

      fetch(`/api/subdivisions/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          subdivisionsContainer.innerHTML = '';
          if (data.subdivisions && data.subdivisions.length > 0) {
            // Update count display
            if (countDisplay) {
              countDisplay.textContent = data.subdivisions.length;
            }

            data.subdivisions.forEach((subdivision, index) => {
              const card = createPropertyCard(subdivision);
              card.classList.add('opacity-0', 'translate-y-4');
              subdivisionsContainer.appendChild(card);
              
              // Animate cards
              setTimeout(() => {
                card.classList.remove('opacity-0', 'translate-y-4');
                card.classList.add('transition-all', 'duration-500', 'ease-out', 'opacity-100', 'translate-y-0');
              }, 50 * index);
            });
          } else {
            subdivisionsContainer.innerHTML = `
              <div class="col-span-full bg-gray-50 p-12 rounded-2xl text-center">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No properties found</h3>
                <p class="text-gray-500">Try different search terms or check back later.</p>
              </div>
            `;
            // Update count display to 0
            if (countDisplay) {
              countDisplay.textContent = '0';
            }
          }
        })
        .catch(err => {
          console.error('Error fetching properties:', err);
          subdivisionsContainer.innerHTML = `
            <div class="col-span-full bg-red-50 p-12 rounded-2xl text-center">
              <svg class="mx-auto h-16 w-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <h3 class="text-xl font-medium text-red-800 mb-2">Error loading properties</h3>
              <p class="text-red-600">Please try again later or contact support if the problem persists.</p>
            </div>
          `;
        });
    } else {
      subdivisionsContainer.innerHTML = `
        <div class="col-span-full bg-blue-50 p-12 rounded-2xl text-center">
          <svg class="mx-auto h-16 w-16 text-blue-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-xl font-medium text-blue-800 mb-2">Enter search terms</h3>
          <p class="text-blue-600">Type in the search box above to find properties.</p>
        </div>
      `;
      // Reset count display
      if (countDisplay) {
        countDisplay.textContent = '0';
      }
    }
  }
</script>

<script>
  // Update Cities based on the selected Province
function updateCities() {
  const provinceId = document.getElementById('province-dropdown').value;
  const cityDropdown = document.getElementById('city-dropdown');
  
  cityDropdown.innerHTML = '<option value="">Select a City</option>';  // Clear existing options

  if (provinceId) {
    fetch(`/api/cities/${provinceId}/`)  // Replace with the correct API endpoint
      .then(response => response.json())
      .then(data => {
        if (data.cities && data.cities.length > 0) {
          data.cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.id;
            option.textContent = city.name;
            cityDropdown.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.disabled = true;
          option.textContent = "No cities available";
          cityDropdown.appendChild(option);
        }
      })
      .catch(err => console.error('Error fetching cities:', err));
  }
}

  function logImageData(subdivision) {
    console.log("Subdivision images:", {
      name: subdivision.name,
      image1: subdivision.image1,
      image2: subdivision.image2,
      image3: subdivision.image3,
      image4: subdivision.image4
    });
  }
function updateSubdivisionsByPrice() {
  const cityId = document.getElementById('city-dropdown').value;
  const priceRange = document.getElementById('price-range-dropdown').value;
  const subdivisionsContainer = document.getElementById('subdivisions-container');
  const preview = document.getElementById('subdivision-preview');

  // Remove any existing count displays
  const existingCountDisplays = document.querySelectorAll('.properties-count-display');
  existingCountDisplays.forEach(display => display.remove());

  subdivisionsContainer.innerHTML = '';
  preview.classList.add('hidden');

  if (cityId) {
    // Show loading indicator with improved design
    subdivisionsContainer.innerHTML = `
      <div class="col-span-full flex items-center justify-center p-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <span class="ml-3 text-lg text-gray-600">Loading properties...</span>
      </div>
    `;
    
    let apiUrl = priceRange === "all" 
      ? `/api/subdivisions/${cityId}/`
      : `/api/subdivisions/by-price-range/${cityId}/${priceRange}/`;

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        subdivisionsContainer.innerHTML = '';
        if (data.subdivisions && data.subdivisions.length > 0) {
          // Results count with animation - now as a separate element before the container
          const countDisplay = document.createElement('div');
          countDisplay.classList.add('w-full', 'mb-6', 'opacity-0', 'transform', 'translate-y-4', 'properties-count-display');
          countDisplay.innerHTML = `
            <div class="inline-flex items-center justify-between bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-100">
              <p class="text-lg text-gray-700">
                <span class="font-semibold">${data.subdivisions.length}</span> properties found
              </p>
              <div class="flex gap-2 ml-4">
                <button onclick="toggleViewMode('grid')" class="p-1.5 rounded-lg hover:bg-gray-100 transition" title="Grid View">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                  </svg>
                </button>
                <button onclick="toggleViewMode('list')" class="p-1.5 rounded-lg hover:bg-gray-100 transition" title="List View">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
              </div>
            </div>
          `;
          
          // Insert count display before the container
          subdivisionsContainer.parentNode.insertBefore(countDisplay, subdivisionsContainer);
          
          // Animate count display
          setTimeout(() => {
            countDisplay.classList.remove('opacity-0', 'translate-y-4');
            countDisplay.classList.add('transition-all', 'duration-500', 'ease-out', 'opacity-100', 'translate-y-0');
          }, 100);
          
          // Display properties with staggered animation
          data.subdivisions.forEach((subdivision, index) => {
            const card = createPropertyCard(subdivision);
            card.classList.add('opacity-0', 'translate-y-4');
            subdivisionsContainer.appendChild(card);
            
            setTimeout(() => {
              card.classList.remove('opacity-0', 'translate-y-4');
              card.classList.add('transition-all', 'duration-500', 'ease-out', 'opacity-100', 'translate-y-0');
            }, 150 + (index * 100));
          });
        } else {
          subdivisionsContainer.innerHTML = `
            <div class="col-span-full bg-white p-12 rounded-2xl text-center border border-gray-100 shadow-sm">
              <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <h3 class="text-xl font-medium text-gray-900 mb-2">No properties found</h3>
              <p class="text-gray-500">Try adjusting your search criteria or check back later.</p>
            </div>
          `;
        }
      })
      .catch(err => {
        console.error('Error fetching subdivisions:', err);
        subdivisionsContainer.innerHTML = `
          <div class="col-span-full bg-red-50 p-12 rounded-2xl text-center border border-red-100">
            <svg class="mx-auto h-16 w-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-medium text-red-800 mb-2">Error loading properties</h3>
            <p class="text-red-600">Please try again later or contact support if the problem persists.</p>
          </div>
        `;
      });
  } else {
    subdivisionsContainer.innerHTML = `
      <div class="col-span-full bg-blue-50 p-12 rounded-2xl text-center border border-blue-100">
        <svg class="mx-auto h-16 w-16 text-blue-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-xl font-medium text-blue-800 mb-2">Select a city</h3>
        <p class="text-blue-600">Choose a city from the dropdown menu above to view available properties.</p>
      </div>
    `;
  }
}

function createPropertyCard(subdivision) {
  const card = document.createElement('div');
  card.classList.add(
    'bg-white',
    'rounded-2xl',
    'shadow-lg',
    'p-6',
    'border',
    'border-gray-100',
    'transition',
    'duration-300',
    'hover:shadow-xl',
    'hover:translate-y-[-5px]',
    'group'
  );

  const imageUrls = [subdivision.image1, subdivision.image2, subdivision.image3, subdivision.image4].filter(Boolean);
  
  let imageGallery = '';
  if (imageUrls.length > 0) {
    imageGallery = `
      <div class="relative w-full h-56 overflow-hidden rounded-xl mb-6 shadow-md group">
        <img 
          src="${imageUrls[0]}" 
          alt="${subdivision.name}" 
          class="w-full h-full object-cover group-hover:scale-105 transition duration-500"
        >
        ${imageUrls.length > 1 ? `
          <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded-lg text-sm">
            +${imageUrls.length - 1} more
          </div>
        ` : ''}
      </div>
    `;
  }

  let editButton = '';
  if (window.isUserSuperuser && subdivision.id) {
    editButton = `
      <a href="/viewproperties/edit/${subdivision.id}/"
         class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl text-base font-medium hover:bg-gray-50 transition flex items-center">
        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
        </svg>
        Edit
      </a>
    `;
  }

  const buttons = `
    <div class="flex flex-wrap gap-2">
      ${subdivision.messenger_link ? `
        <button 
          class="open-messenger-modal flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-base font-medium hover:from-blue-700 hover:to-blue-800 transition shadow-md flex items-center justify-center"
          data-link="${subdivision.messenger_link}"
          type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Contact via Messenger
        </button>
      ` : ''}
      ${editButton}
    </div>
  `;

  card.innerHTML = `
    ${imageGallery}
    <h4 class="text-2xl font-bold text-gray-800 mb-2">
      ${subdivision.name}
    </h4>
    
    <div class="flex flex-wrap gap-2 mb-3">
      <span class="inline-block bg-gradient-to-r from-yellow-300 to-yellow-400 text-yellow-900 text-lg font-bold px-3 py-1 rounded-full shadow-sm">
        ${subdivision.commission}% COMM
      </span>
      <span class="inline-block ${
        subdivision.priority === 'high' ? 'bg-red-100 text-red-700' :
        subdivision.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
        'bg-green-100 text-green-700'
      } text-lg font-semibold px-3 py-1 rounded-full shadow-sm">
        ${subdivision.priority.charAt(0).toUpperCase() + subdivision.priority.slice(1)} Priority
      </span>
    </div>
    
    <p class="text-gray-500 text-lg mb-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      ${subdivision.city}, ${subdivision.province}
    </p>

    <p class="text-gray-600 text-xl font-semibold mb-4">${subdivision.price_range_display ? subdivision.price_range_display : ''}</p>
    
    <p class="text-gray-700 text-lg line-clamp-2 mb-6">
      ${subdivision.description ? subdivision.description : 'No description available'}
    </p>
    
    ${buttons}
  `;

  // Add click event for the entire card
  card.addEventListener('click', (e) => {
    // Only show preview if not clicking on buttons or links
    if (!e.target.closest('button') && !e.target.closest('a')) {
      showSubdivisionPreview(subdivision);
    }
  });

  // Add specific click event for messenger modal
  const messengerBtn = card.querySelector('.open-messenger-modal');
  if (messengerBtn) {
    messengerBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent card click
      const link = messengerBtn.getAttribute('data-link');
      if (link) openMessengerModal(link);
    });
  }

  return card;
}

let currentViewMode = 'grid';

function toggleViewMode(mode) {
  if (mode === currentViewMode) return;
  
  const container = document.getElementById('subdivisions-container');
  const gridBtn = document.querySelectorAll('button[onclick="toggleViewMode(\'grid\')"]');
  const listBtn = document.querySelectorAll('button[onclick="toggleViewMode(\'list\')"]');
  
  currentViewMode = mode;
  
  if (mode === 'grid') {
    container.classList.remove('grid-cols-1');
    container.classList.add('md:grid-cols-2', 'xl:grid-cols-3');
    
    // Highlight grid button
    gridBtn.forEach(btn => btn.classList.add('bg-gray-100'));
    listBtn.forEach(btn => btn.classList.remove('bg-gray-100'));
  } else {
    container.classList.remove('md:grid-cols-2', 'xl:grid-cols-3');
    container.classList.add('grid-cols-1');
    
    // Highlight list button
    listBtn.forEach(btn => btn.classList.add('bg-gray-100'));
    gridBtn.forEach(btn => btn.classList.remove('bg-gray-100'));
  }

  // Update card layouts
  const cards = container.querySelectorAll('.bg-white');
  cards.forEach(card => {
    if (mode === 'list') {
      // Set up list view layout
      card.classList.add('flex', 'flex-col', 'md:flex-row', 'gap-6');
      
      // Handle image container
      const imageContainer = card.querySelector('[class*="overflow-hidden"]');
      if (imageContainer) {
        imageContainer.classList.remove('h-56', 'w-full');
        imageContainer.classList.add('md:w-72', 'h-48', 'flex-shrink-0');
      }

      // Create content wrapper if it doesn't exist
      let contentWrapper = card.querySelector('.content-wrapper');
      if (!contentWrapper) {
        contentWrapper = document.createElement('div');
        contentWrapper.className = 'content-wrapper flex-grow min-w-0';
        
        // Move all non-image content into the wrapper
        Array.from(card.children).forEach(child => {
          if (!child.classList.contains('overflow-hidden') && child !== contentWrapper) {
            contentWrapper.appendChild(child);
          }
        });
        
        // Insert wrapper after image
        if (imageContainer) {
          imageContainer.after(contentWrapper);
        }
      }

      // Adjust content spacing
      const title = contentWrapper.querySelector('h4');
      const badges = contentWrapper.querySelector('.flex.flex-wrap.gap-2');
      const location = contentWrapper.querySelector('.text-gray-500');
      const price = contentWrapper.querySelector('.text-gray-600');
      const description = contentWrapper.querySelector('.text-gray-700');
      const buttons = contentWrapper.querySelector('.flex.flex-wrap.gap-2:last-child');

      if (title) title.classList.add('text-xl', 'md:text-2xl', 'mb-2');
      if (badges) badges.classList.add('mb-2');
      if (location) location.classList.add('mb-1');
      if (price) price.classList.add('mb-2');
      if (description) description.classList.add('mb-4');
      if (buttons) buttons.classList.add('mt-auto');

    } else {
      // Restore grid view layout
      card.classList.remove('flex', 'flex-col', 'md:flex-row', 'gap-6');
      
      // Restore image container
      const imageContainer = card.querySelector('[class*="overflow-hidden"]');
      if (imageContainer) {
        imageContainer.classList.remove('md:w-72', 'h-48', 'flex-shrink-0');
        imageContainer.classList.add('h-56', 'w-full');
      }

      // Unwrap content if needed
      const contentWrapper = card.querySelector('.content-wrapper');
      if (contentWrapper) {
        while (contentWrapper.firstChild) {
          card.appendChild(contentWrapper.firstChild);
        }
        contentWrapper.remove();
      }

      // Reset content spacing
      const title = card.querySelector('h4');
      const badges = card.querySelector('.flex.flex-wrap.gap-2');
      const location = card.querySelector('.text-gray-500');
      const price = card.querySelector('.text-gray-600');
      const description = card.querySelector('.text-gray-700');
      const buttons = card.querySelector('.flex.flex-wrap.gap-2:last-child');

      if (title) title.classList.remove('text-xl', 'md:text-2xl', 'mb-2');
      if (badges) badges.classList.remove('mb-2');
      if (location) badges.classList.remove('mb-1');
      if (price) price.classList.remove('mb-2');
      if (description) description.classList.remove('mb-4');
      if (buttons) buttons.classList.remove('mt-auto');
    }
  });
}

// Initialize view mode on page load
document.addEventListener('DOMContentLoaded', () => {
  toggleViewMode('grid');
});

// Modal handling functions
function openMessengerModal(link) {
  const modal = document.getElementById('messenger-modal');
  const input = document.getElementById('messenger-url-input');
  const success = document.getElementById('copy-success');

  if (input) input.value = link;
  if (success) success.classList.add('hidden');
  if (modal) {
    modal.classList.remove('hidden');
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeMessengerModal();
      }
    });
  }
}

function closeMessengerModal() {
  const modal = document.getElementById('messenger-modal');
  if (modal) modal.classList.add('hidden');
}

// Initialize modal event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Close button handler
  const closeBtn = document.getElementById('close-messenger-modal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeMessengerModal);
  }

  // Copy link button handler
  const copyBtn = document.getElementById('copy-link-btn');
  if (copyBtn) {
    copyBtn.addEventListener('click', () => {
      const input = document.getElementById('messenger-url-input');
      const success = document.getElementById('copy-success');
      
      if (input) {
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        if (success) {
          success.classList.remove('hidden');
          setTimeout(() => success.classList.add('hidden'), 2000);
        }
      }
    });
  }

  // ESC key to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMessengerModal();
    }
  });
});

function showSubdivisionPreview(subdivision) {
  const preview = document.getElementById('subdivision-preview');
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const mainImage = document.getElementById('main-subdivision-image');
  const thumbnailsContainer = document.getElementById('subdivision-thumbnails');

  // Hide any previous states
  preview.classList.add('hidden');
  errorState.classList.add('hidden');
  
  // Show loading state
  loadingState.classList.remove('hidden');
  loadingState.scrollIntoView({ behavior: 'smooth', block: 'start' });

  try {
    const imageUrls = [
      subdivision.image1,
      subdivision.image2,
      subdivision.image3,
      subdivision.image4
    ].filter(Boolean);

    if (imageUrls.length > 0) {
      mainImage.src = imageUrls[0];
      mainImage.alt = subdivision.name;
    } else {
      mainImage.src = '/media/subdivisions/default.jpg';
      mainImage.alt = 'Default image';
    }

    thumbnailsContainer.innerHTML = '';
    imageUrls.forEach((url, index) => {
      const thumbContainer = document.createElement('div');
      thumbContainer.style.cssText = 'height: 90px; min-height: 90px; max-height: 90px; width: 120px; min-width: 120px; max-width: 120px;';
      thumbContainer.classList.add('overflow-hidden', 'rounded-lg', 'shadow-sm');

      const thumb = document.createElement('img');
      thumb.src = url;
      thumb.alt = `${subdivision.name} image ${index + 1}`;
      thumb.style.cssText = 'height: 100%; width: 100%; object-fit: cover;';
      thumb.classList.add(
        'cursor-pointer',
        'border-2',
        index === 0 ? 'border-blue-500' : 'border-transparent',
        'hover:border-blue-500',
        'transition'
      );

      thumb.onclick = () => {
        mainImage.src = url;
        mainImage.alt = `${subdivision.name} image ${index + 1}`;
        thumbnailsContainer.querySelectorAll('img').forEach((img, i) => {
          img.classList.toggle('border-blue-500', i === index);
          img.classList.toggle('border-transparent', i !== index);
        });
      };

      thumbContainer.appendChild(thumb);
      thumbnailsContainer.appendChild(thumbContainer);
    });

    // Set subdivision details
    document.getElementById('subdivision-name').textContent = subdivision.name;
    document.getElementById('subdivision-price').textContent = subdivision.price_range_display || '';
    document.getElementById('subdivision-house-model').textContent = subdivision.house_model || 'Not specified';
    document.getElementById('subdivision-description').textContent = subdivision.description || 'Not specified';
    document.getElementById('subdivision-construction-status').textContent = subdivision.construction_status || 'Not specified';
    document.getElementById('subdivision-developer').textContent = subdivision.developer || 'Not specified';
    document.getElementById('subdivision-location').textContent = subdivision.location || 'Not specified';
    document.getElementById('subdivision-commission').textContent = `${subdivision.commission}% COMM`;
    document.getElementById('subdivision-priority').textContent = subdivision.priority.charAt(0).toUpperCase() + subdivision.priority.slice(1);

    // Show Google Drive link row if available
    const googleDriveRow = document.getElementById('google-drive-row');
    const googleDriveLink = document.getElementById('google-drive-link');
    if (subdivision.google_drive_link) {
      googleDriveLink.href = subdivision.google_drive_link;
      googleDriveRow.classList.remove('hidden');
    } else {
      googleDriveRow.classList.add('hidden');
    }

    // Handle Messenger Link
    const messengerContainer = document.getElementById('messenger-link-container');
    if (subdivision.messenger_link) {
      messengerContainer.innerHTML = `
        <button 
          class="open-messenger-modal w-full sm:w-auto px-6 py-4 bg-white text-blue-700 text-xl font-medium rounded-xl hover:bg-gray-100 transition shadow-lg flex items-center group"
          data-link="${subdivision.messenger_link}"
          type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3 text-blue-700 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Contact via Messenger
          <span class="ml-2 text-blue-500 group-hover:translate-x-1 transition-transform">→</span>
        </button>
      `;
      messengerContainer.classList.remove('hidden');

      // Add click event for the new messenger button
      const messengerBtn = messengerContainer.querySelector('.open-messenger-modal');
      if (messengerBtn) {
        messengerBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const link = messengerBtn.getAttribute('data-link');
          if (link) openMessengerModal(link);
        });
      }
    } else {
      messengerContainer.classList.add('hidden');
    }

    // Hide loading state and show preview
    loadingState.classList.add('hidden');
    preview.classList.remove('hidden');
    preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    console.error('Error showing subdivision preview:', error);
    loadingState.classList.add('hidden');
    document.getElementById('error-message').textContent = 'An error occurred while loading the property details. Please try again.';
    errorState.classList.remove('hidden');
    errorState.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}
</script>

{% endblock %}